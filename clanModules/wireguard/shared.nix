{ lib }:
{
  instanceOptions = {

    # TODO: This should be autogenerated
    address = lib.mkOption {
      type = lib.types.str;
    };

    name = lib.mkOption {
      type = lib.types.nullOr lib.types.str;
      default = null;
    };

    # TODO: We should split this into attrsOf address and port
    endpoint = lib.mkOption {
      type = lib.types.str;
    };

    listenPort = lib.mkOption {
      type = lib.types.port;
      default = 6666;
    };
  };

  generator =
    { wireguard-tools }:
    {
      files.private-key = { };
      files.public-key.secret = false;

      script = ''
        wg genkey > "$out/private-key"
        wg pubkey < "$out/private-key" > "$out/public-key"
      '';

      runtimeInputs = [ wireguard-tools ];
    };
}
